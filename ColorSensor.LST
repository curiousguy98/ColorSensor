C51 COMPILER V9.00   COLORSENSOR                                                           02/10/2015 14:56:53 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE COLORSENSOR
OBJECT MODULE PLACED IN ColorSensor.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ColorSensor.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          
   2          #include        "LPCREG.H"
   3          
   4          #define uchar unsigned char
   5          #define uint  unsigned int
   6          
   7          /*************  用户系统配置    **************/
   8          
   9          #define MAIN_Fosc               18432000L       //定义主时钟, 模拟串口和和延时会自动适应。5~35MHZ
  10          
  11          //=================颜色传感模块连接=====================
  12          /*-----------------------------------------------------
  13                 |EO-----GND
  14                 |S0-----VCC | S2-----P1.0 | OUT-------P3.5 
  15                 |S1-----VCC | S3-----P1.1 | 
  16            ---------------------------------------------------*/
  17          sbit    tcs230_s2=P1^0;//TCS230 S2接单片机P1.0
  18          sbit    tcs230_s3=P1^1;//TCS230 S3接单片机P1.1
  19          sbit    tcs230_en=P3^0; //TCS230 EN(E0)接GND
  20          
  21          void    DelayMs(uint Ms);//1MS基准延时程序
  22          void    baipingheng();//白平衡子程序
  23          void    celiang();//实际颜色程序
  24          uint    ryz,gyz,byz;//分别定义红色因子 绿色因子 蓝色因子
  25          uint    rb,gb,bb;//RGB值
  26          
  27          /************* 本地变量声明 **************/
  28          sbit    P_TXD1 = P3^1;
  29          /************* 本地函数声明 **************/
  30          void    Tx1Send(uchar dat);
  31          void    PrintString(unsigned char code *puts);
  32          
  33          /*====================================================================
  34            设定延时时间:x*1ms
  35          ====================================================================*/
  36          void DelayMs(uint Ms)
  37          {
  38   1        uint i,TempCyc;
  39   1        for(i=0;i<Ms;i++)
  40   1        {
  41   2          TempCyc = 250;
  42   2          while(TempCyc--);
  43   2        }
  44   1      }
  45          
  46          main()   
  47          {   
  48   1              AUXR &= 0x3F;           //定时器时钟12T模式
  49   1              TMOD=0x51;//设定T0以工作方式1定时10毫秒
  50   1              TMOD &= 0xF0;           //设置定时器模式
  51   1              TMOD |= 0x01; //使用定时器T0的模式1    
  52   1              TR0 = 0; //定时器T0关闭   
  53   1              TR1 = 0;                //定时器关闭
  54   1              EA = 1; //开启总中断   
  55   1      
C51 COMPILER V9.00   COLORSENSOR                                                           02/10/2015 14:56:53 PAGE 2   

  56   1      PrintString("****** START ******\r\n"); 
  57   1      
  58   1         baipingheng();//上电时先白平衡一次
  59   1         while(1)
  60   1         {
  61   2             celiang();//颜色测试
  62   2      
  63   2             DelayMs(250);//每隔0.25秒测试一次颜色
  64   2         }
  65   1      } 
  66          //******************************************************
  67          //白平衡子程序
  68          void   celiang()
  69          {
  70   1           //*********求R值************************************
  71   1          TR0=0;
  72   1              TF0=0;   
  73   1           TH0=(65536-15360)/256;
  74   1               TL0=(65536-15360)%256;
  75   1           TH1=0;
  76   1           TL1=0;
  77   1           tcs230_s2=0;
  78   1           tcs230_s3=0;//选择红色滤光器
  79   1           tcs230_en=0;
  80   1           TR0=1;//10毫秒开始计时
  81   1           TR1=1;//开始计数
  82   1           while(TF0==0);//等待定时器溢出
  83   1           TF0=0;//清楚定时器0溢出标志
  84   1           TR0=0;//关闭定时0
  85   1           TR1=0;
  86   1           rb=(unsigned long)(TH1*256+TL1)*255/ryz;
  87   1           if(rb>255)rb=255;//判断RGB值是否合法
  88   1           //***********求B值**************************************
  89   1          TR0=0;
  90   1              TF0=0;
  91   1           TH0=(65536-15360)/256;
  92   1               TL0=(65536-15360)%256;
  93   1           TH1=0;
  94   1           TL1=0;
  95   1           tcs230_s2=0;
  96   1           tcs230_s3=1;//选择蓝色滤光器
  97   1           TR0=1;//10毫秒开始计时
  98   1           TR1=1;//开始计数
  99   1           while(TF0==0);//等待定时器溢出
 100   1           TF0=0;//清楚定时器0溢出标志
 101   1           TR0=0;//关闭定时0
 102   1           TR1=0;
 103   1           bb=(unsigned long)(TH1*256+TL1)*255/byz;
 104   1           if(bb>255)bb=255;//判断RGB值是否合法     
 105   1           //***********求G值**************************************   
 106   1          TR0=0;
 107   1              TF0=0;
 108   1           TH0=(65536-15360)/256;
 109   1               TL0=(65536-15360)%256;
 110   1           TH1=0;
 111   1           TL1=0;
 112   1           tcs230_s2=1;
 113   1           tcs230_s3=1;//选择绿色滤光器
 114   1           TR0=1;//10毫秒开始计时
 115   1           TR1=1;//开始计数
 116   1           while(TF0==0);//等待定时器溢出
 117   1           TF0=0;//清楚定时器0溢出标志
C51 COMPILER V9.00   COLORSENSOR                                                           02/10/2015 14:56:53 PAGE 3   

 118   1           TR0=0;//关闭定时0
 119   1           TR1=0;
 120   1           tcs230_en=1;
 121   1           gb=(unsigned long)(TH1*256+TL1)*255/gyz;
 122   1           if(gb>255)gb=255;//判断RGB值是否合法  
 123   1      
 124   1      
 125   1      Tx1Send('R');
 126   1      Tx1Send(rb/256);
 127   1      Tx1Send(rb%256);
 128   1      Tx1Send('G');
 129   1      Tx1Send(gb/256);
 130   1      Tx1Send(gb%256);
 131   1      Tx1Send('B');
 132   1      Tx1Send(bb/256);
 133   1      Tx1Send(bb%256);
 134   1      Tx1Send(' ');
 135   1      Tx1Send('\r');
 136   1      Tx1Send('\n');
 137   1      
 138   1      }
 139          //******************************************************
 140          //白平衡子程序
 141          void    baipingheng()
 142          {
 143   1           //**************求取红色因子***********************
 144   1          TR0=0;
 145   1              TF0=0;   
 146   1           TH0=(65536-15360)/256;
 147   1               TL0=(65536-15360)%256;
 148   1           TH1=0;
 149   1           TL1=0;
 150   1           tcs230_s2=0;
 151   1           tcs230_s3=0;//选择红色滤光器
 152   1           tcs230_en=0;
 153   1           TR0=1;//10毫秒开始计时
 154   1           TR1=1;//开始计数
 155   1           while(TF0==0);//等待定时器溢出
 156   1           TF0=0;//清楚定时器0溢出标志
 157   1           TR0=0;//关闭定时0
 158   1           TR1=0;
 159   1           ryz=TH1*256+TL1;//其实这里的比例因子应该为255/(TH1*256+TL1)
 160   1           //**************求取蓝色因子***********************
 161   1          TR0=0;
 162   1              TF0=0;   
 163   1           TH0=(65536-15360)/256;
 164   1               TL0=(65536-15360)%256;
 165   1           TH1=0;
 166   1           TL1=0;
 167   1           tcs230_s2=0;
 168   1           tcs230_s3=1;//选择蓝色滤光器
 169   1           TR0=1;//10毫秒开始计时
 170   1           TR1=1;//开始计数
 171   1           while(TF0==0);//等待定时器溢出
 172   1           TF0=0;//清楚定时器0溢出标志
 173   1           TR0=0;//关闭定时0
 174   1           TR1=0;
 175   1           byz=TH1*256+TL1;//其实这里的比例因子应该为255/(TH1*256+TL1)
 176   1           //**************求绿红色因子***********************
 177   1          TR0=0;
 178   1              TF0=0;   
 179   1           TH0=(65536-15360)/256;
C51 COMPILER V9.00   COLORSENSOR                                                           02/10/2015 14:56:53 PAGE 4   

 180   1               TL0=(65536-15360)%256;
 181   1           TH1=0;
 182   1           TL1=0;
 183   1           tcs230_s2=1;
 184   1           tcs230_s3=1;//选择绿色滤光器
 185   1           TR0=1;//10毫秒开始计时
 186   1           TR1=1;//开始计数
 187   1           while(TF0==0);//等待定时器溢出
 188   1           TF0=0;//清楚定时器0溢出标志
 189   1           TR0=0;//关闭定时0
 190   1           TR1=0;
 191   1           tcs230_en=1;
 192   1           gyz=TH1*256+TL1;//其实这里的比例因子应该为255/(TH1*256+TL1)
 193   1      
 194   1      Tx1Send('R');
 195   1      Tx1Send(ryz/256);
 196   1      Tx1Send(ryz%256);
 197   1      Tx1Send('G');
 198   1      Tx1Send(gyz/256);
 199   1      Tx1Send(gyz%256);
 200   1      Tx1Send('B');
 201   1      Tx1Send(byz/256);
 202   1      Tx1Send(byz%256);
 203   1      
 204   1      
 205   1      Tx1Send(' ');
 206   1      Tx1Send('\r');
 207   1      Tx1Send('\n');
 208   1      
 209   1      }
 210          
 211          
 212          /********************** 模拟串口相关函数************************/
 213          
 214          void    BitTime(void)   //位时间函数
 215          {
 216   1              uint i;
 217   1              i = ((MAIN_Fosc / 100) * 8) / 140000L - 1;              //根据主时钟来计算位时间 104为9600，8为115200
 218   1              while(--i);
 219   1      }
 220          
 221          //模拟串口发送
 222          void    Tx1Send(uchar dat)              //9600，N，8，1         发送一个字节
 223          {
 224   1              uchar   i;
 225   1              EA = 0;
 226   1              P_TXD1 = 0;
 227   1              BitTime();
 228   1              for(i=0; i<8; i++)
 229   1              {
 230   2                      if(dat & 1)             P_TXD1 = 1;
 231   2                      else                    P_TXD1 = 0;
 232   2                      dat >>= 1;
 233   2                      BitTime();
 234   2              }
 235   1              P_TXD1 = 1;
 236   1              EA = 1;
 237   1              BitTime();
 238   1              BitTime();
 239   1      }
 240          
 241          void PrintString(unsigned char code *puts)              //发送一串字符串
C51 COMPILER V9.00   COLORSENSOR                                                           02/10/2015 14:56:53 PAGE 5   

 242          {
 243   1          for (; *puts != 0;  puts++)  Tx1Send(*puts);        //遇到停止符0结束
 244   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    699    ----
   CONSTANT SIZE    =     22    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     12    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
